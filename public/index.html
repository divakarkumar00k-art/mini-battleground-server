<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Mini Battleground</title>

<style>
body {
  margin: 0;
  overflow: hidden;
  background: #2e6b2e;
  font-family: Arial;
}

canvas {
  display: block;
}

#ui {
  position: fixed;
  top: 10px;
  right: 10px;
  color: white;
  font-size: 14px;
}

#joystickContainer {
  position: fixed;
  bottom: 30px;
  left: 20px;
  width: 110px;
  height: 110px;
}

#joystickBase {
  width: 100%;
  height: 100%;
  background: rgba(255,255,255,0.15);
  border-radius: 50%;
  position: relative;
  touch-action: none;
}

#joystickStick {
  width: 45px;
  height: 45px;
  background: rgba(0,0,255,0.7);
  border-radius: 50%;
  position: absolute;
  left: 32px;
  top: 32px;
}

#fireButton {
  position: fixed;
  bottom: 50px;
  right: 40px;
  width: 90px;
  height: 90px;
  background: rgba(255,0,0,0.7);
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  color: white;
  font-weight: bold;
}
</style>
</head>

<body>

<canvas id="gameCanvas"></canvas>

<div id="ui">
  <div>Alive: <span id="alive">1</span></div>
  <div>Kills: <span id="kills">0</span></div>
  <div>Health: <span id="health">100</span></div>
</div>

<div id="joystickContainer">
  <div id="joystickBase">
    <div id="joystickStick"></div>
  </div>
</div>

<div id="fireButton">FIRE</div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let player = { x: canvas.width/2, y: canvas.height/2, dirX:1, dirY:0 };
let players = {};
let bullets = [];
let kills = 0;
let health = 100;

const socket = new WebSocket("wss://mini-battleground-server-production.up.railway.app");

socket.onmessage = (event) => {
  const data = JSON.parse(event.data);

  if (data.type === "playerMove") {
    players[data.playerId] = { x: data.x, y: data.y };
  }

  if (data.type === "playerHit") {
    health = data.health;
    document.getElementById("health").innerText = health;
  }

  if (data.type === "killUpdate") {
    kills = data.kills;
    document.getElementById("kills").innerText = kills;
  }

  if (data.type === "playerCount") {
    document.getElementById("alive").innerText = data.total;
  }
};

function drawPlayer(p, isSelf=false) {
  ctx.save();
  ctx.translate(p.x, p.y);

  let angle = Math.atan2(p.dirY || 0, p.dirX || 1);
  ctx.rotate(angle);

  ctx.fillStyle = isSelf ? "#2b6cff" : "#ff3b3b";
  ctx.fillRect(-12, -15, 24, 30);

  ctx.fillStyle = "#ffd6a5";
  ctx.beginPath();
  ctx.arc(0, -22, 8, 0, Math.PI*2);
  ctx.fill();

  ctx.fillStyle = "#333";
  ctx.fillRect(-9, -28, 18, 6);

  ctx.fillStyle = "#111";
  ctx.fillRect(10, -3, 20, 6);

  ctx.restore();
}

function drawBullets() {
  ctx.fillStyle = "yellow";
  bullets.forEach(b => {
    ctx.beginPath();
    ctx.arc(b.x, b.y, 4, 0, Math.PI*2);
    ctx.fill();
  });
}

function updateBullets() {
  bullets.forEach(b => {
    b.x += b.vx;
    b.y += b.vy;
  });
  bullets = bullets.filter(b =>
    b.x > 0 && b.x < canvas.width &&
    b.y > 0 && b.y < canvas.height
  );
}

function gameLoop() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  updateBullets();
  drawBullets();

  drawPlayer(player, true);

  for (let id in players) {
    drawPlayer(players[id], false);
  }

  requestAnimationFrame(gameLoop);
}
gameLoop();

// JOYSTICK
const base = document.getElementById("joystickBase");
const stick = document.getElementById("joystickStick");

let dragging = false;
let currentX = 0;
let currentY = 0;
let moveInterval = null;
let maxDistance = 40;

base.addEventListener("touchstart", () => {
  dragging = true;

  moveInterval = setInterval(() => {
    if (!dragging) return;

    player.x += currentX * 0.1;
    player.y += currentY * 0.1;

    player.dirX = currentX;
    player.dirY = currentY;

    socket.send(JSON.stringify({
      type: "move",
      x: player.x,
      y: player.y
    }));
  }, 50);
});

base.addEventListener("touchend", () => {
  dragging = false;
  clearInterval(moveInterval);
  stick.style.left = "32px";
  stick.style.top = "32px";
});

base.addEventListener("touchmove", (e) => {
  if (!dragging) return;

  const rect = base.getBoundingClientRect();
  const touch = e.touches[0];

  let x = touch.clientX - rect.left - 55;
  let y = touch.clientY - rect.top - 55;

  const distance = Math.sqrt(x*x + y*y);

  if (distance > maxDistance) {
    x = (x / distance) * maxDistance;
    y = (y / distance) * maxDistance;
  }

  currentX = x;
  currentY = y;

  stick.style.left = 32 + x + "px";
  stick.style.top = 32 + y + "px";
});

// FIRE
const fireButton = document.getElementById("fireButton");

fireButton.addEventListener("touchstart", () => {

  let angle = Math.atan2(player.dirY, player.dirX);
  let speed = 8;

  bullets.push({
    x: player.x,
    y: player.y,
    vx: Math.cos(angle) * speed,
    vy: Math.sin(angle) * speed
  });

});
</script>

</body>
</html>
